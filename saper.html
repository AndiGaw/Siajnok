<!DOCTYPE html>
<html lang="pl">
<head>
<meta charset="UTF-8">
<title>Przeprawa przez Arrakis ‚Äì pe≈Çny klimat</title>

<style>
html, body {
  margin: 0;
  padding: 0;
  height: 100%;
  background: #000;
  color: #e6c47a;
  font-family: "Georgia", serif;
  overflow-x: hidden;
  user-select: none; /* Zapobiega zaznaczaniu tekstu przy szybkim klikaniu */
}

/* ===== T≈ÅO ===== */
body.shake {
  animation: shake 0.5s cubic-bezier(.36,.07,.19,.97) both;
}
@keyframes shake {
  10%, 90% { transform: translate3d(-1px, 0, 0); }
  20%, 80% { transform: translate3d(2px, 0, 0); }
  30%, 50%, 70% { transform: translate3d(-4px, 0, 0); }
  40%, 60% { transform: translate3d(4px, 0, 0); }
}

.sand {
  position: fixed;
  inset: 0;
  background: repeating-linear-gradient(
    45deg,
    rgba(230,196,122,0.2),
    rgba(230,196,122,0.2) 2px,
    rgba(0,0,0,0) 6px
  );
  animation: drift 60s linear infinite;
  pointer-events: none;
  z-index: 1;
}

/* ===== KONTAINER ===== */
.container {
  position: relative;
  z-index: 2;
  text-align: center;
  padding-top: 20px;
}

/* ===== STEROWANIE ===== */
#controls {
  display: flex;
  flex-direction: column;
  align-items: center;
  gap: 12px;
  margin-bottom: 10px;
}
#controls button {
  font-size: 1.2em;
  padding: 10px 20px;
  width: 320px;
  background: #111;
  color: #e6c47a;
  border: 2px solid #e6c47a;
  border-radius: 8px;
  cursor: pointer;
  box-shadow: 0 0 10px rgba(230,196,122,0.5);
}
#controls button:hover {
  background: #222;
  box-shadow: 0 0 20px rgba(230,196,122,0.8);
}

#audioInfo, #stats {
  margin-top: 10px;
  font-size: 0.9em;
  min-height: 1.2em; /* Rezerwacja miejsca */
}

/* ===== GAME AREA ===== */
#game-area {
  display: flex;
  align-items: flex-start;
  gap: 20px;
  margin: 20px auto;
  width: max-content;
}

/* ===== LƒÑDOWISKA ===== */
#helipadA, #helipadB {
  width: 120px;
  height: 120px;
  background: #111;
  border: 2px solid #e6c47a;
  border-radius: 10px;
  display: flex;
  align-items: center;
  justify-content: center;
  font-weight: bold;
  flex-shrink: 0;
}

#helipadB {
  visibility: hidden;
}

/* ===== PLANSZA ===== */
#board-wrapper {
  display: flex;
  flex-direction: column;
  align-items: center;
  min-width: calc(50px * 10 + 3px * 9);
}

#board {
  display: inline-grid;
  gap: 3px;
}

/* ===== KOM√ìRKI ===== */
.cell {
  width: 50px;
  height: 50px;
  background: #222;
  border: 2px solid #e6c47a;
  display: flex;
  align-items: center;
  justify-content: center;
  cursor: pointer;
  font-weight: bold;
  font-size: 1.2em;
}

.visited { background: #444; }
.start   { background: darkgreen; }
.goal    { background: darkblue; }
.worm    { background: darkred; color: white; }
.player  { color: #fff; text-shadow: 0 0 5px #fff; }

/* DEBUG ONLY (ukryty normalnie, ale zostawiam w CSS) */
#worm-map { display: none; }
</style>
</head>

<body>
<div class="sand"></div>

<div class="container">
  <h1>Przeprawa przez Arrakis</h1>
  <p>Przejd≈∫ z punktu <b>A</b> do <b>B</b> unikajƒÖc Czerwii Pustyni!</p>

  <div id="controls">
    <button onclick="playNarrator()">üéôÔ∏è Narrator (T≈Ço)</button>
    <button onclick="showGame(); startGame()">üèúÔ∏è Wyrusz w drogƒô</button>
    <label><input type="checkbox" id="hardMode"> Hard Mode ‚Äì ruchome czerwie</label>
  </div>

  <div id="sonarOutput" style="font-weight: bold; color: #ff5555; text-shadow: 0 0 10px #ff0000; height: 20px;">
    Kliknij start, by uruchomiƒá systemy...
  </div>
  <div id="stats">Kroki: 0 | Punktacja: 0</div>

  <div id="game-area" style="display:none">
    <div id="helipadA">LƒÖdowisko A</div>

    <div id="board-wrapper">
      <div id="board"></div>
    </div>

    <div id="helipadB">LƒÖdowisko B</div>
  </div>
</div>

<script>
// --- ZMIENNE GLOBALNE ---
const size = 10;
const wormsCount = 12;
let board = []; // Przechowuje obiekty: { el: DOMNode, worm: bool, visited: bool }
let playerPos = {x:0, y:0};
let steps = 0;
let gameOver = false;
let audioCtx = null; // Context dla Web Audio API (sonar)

// --- INICJALIZACJA ---
function showGame() {
  document.getElementById("game-area").style.display = "flex";
  // Inicjalizacja audio przy pierwszej interakcji u≈ºytkownika
  if (!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)();
}

function startGame() {
  const boardDiv = document.getElementById("board");
  
  // Reset stanu
  board = [];
  gameOver = false;
  playerPos = {x:0, y:0};
  steps = 0;
  
  // UI Reset
  document.getElementById("helipadB").style.visibility = "hidden";
  document.getElementById("stats").innerText = "Kroki: 0 | Punktacja: 0";
  document.getElementById("sonarOutput").innerText = "";
  document.body.className = ""; // usu≈Ñ efekt trzƒôsienia

  boardDiv.innerHTML = "";
  boardDiv.style.gridTemplateColumns = `repeat(${size},50px)`;

  // Generowanie planszy z cache'owaniem DOM
  for (let y = 0; y < size; y++) {
    board[y] = [];
    for (let x = 0; x < size; x++) {
      const cell = document.createElement("div");
      cell.className = "cell";
      
      // Bezpo≈õrednie przypisanie zdarzenia (szybsze ni≈º onclick w HTML)
      cell.onclick = () => moveTo(x, y);

      boardDiv.appendChild(cell);

      // Zapisujemy referencjƒô do DIVa w tablicy
      board[y][x] = { 
        worm: false, 
        visited: false, 
        el: cell 
      };
    }
  }

  placeWorms();
  drawBoard(); // Pierwsze rysowanie
}

function placeWorms() {
  let placed = 0;
  while (placed < wormsCount) {
    let x = Math.floor(Math.random() * size);
    let y = Math.floor(Math.random() * size);
    // Unikaj startu i mety
    if ((x === 0 && y === 0) || (x === size-1 && y === size-1)) continue;
    
    if (!board[y][x].worm) {
      board[y][x].worm = true;
      placed++;
    }
  }
}

// --- LOGIKA RUCHU I GRY ---

function isAdjacent(x, y) {
  return Math.abs(playerPos.x - x) + Math.abs(playerPos.y - y) === 1;
}

function moveTo(x, y) {
  if (gameOver || !isAdjacent(x, y)) return;
  if (audioCtx && audioCtx.state === 'suspended') audioCtx.resume();

  // 1. Ruch gracza
  playerPos = {x, y};
  steps++;
  board[y][x].visited = true;

  // 2. Sprawdzenie, czy weszli≈õmy na czerwa (przed ruchem czerwi)
  if (board[y][x].worm) {
    killPlayer("Wszed≈Çe≈õ prosto w paszczƒô Czerwia!");
    return;
  }

  // 3. Hard Mode: Ruch czerwii
  if (document.getElementById("hardMode").checked) {
    moveWormsLogic();
    // Po ruchu czerwi sprawdzamy, czy kt√≥ry≈õ nie wszed≈Ç na gracza
    if (board[playerPos.y][playerPos.x].worm) {
      killPlayer("Czerw Pustyni wynurzy≈Ç siƒô pod TobƒÖ!");
      return;
    }
  }

  // 4. Sprawdzenie zwyciƒôstwa
  if (x === size - 1 && y === size - 1) {
    winGame();
    return;
  }

  // 5. Aktualizacja widoku i sonaru
  drawBoard();
  updateSonarAndStats();
}

function moveWormsLogic() {
  // Znajd≈∫ wszystkie czerwie
  let worms = [];
  for(let y=0; y<size; y++) {
    for(let x=0; x<size; x++) {
      if(board[y][x].worm) {
        worms.push({x, y});
        board[y][x].worm = false; // Usuwamy ze starej pozycji
      }
    }
  }

  // Przetasuj tablicƒô czerwi (≈ºeby nie rusza≈Çy siƒô zawsze w tej samej kolejno≈õci)
  worms.sort(() => Math.random() - 0.5);

  worms.forEach(w => {
    const dirs = [[0,0], [0,1], [0,-1], [1,0], [-1,0]];
    let moved = false;
    
    // Spr√≥buj znale≈∫ƒá legalny ruch (max 5 pr√≥b losowych)
    for(let i=0; i<5; i++) {
        const d = dirs[Math.floor(Math.random() * dirs.length)];
        const nx = w.x + d[0];
        const ny = w.y + d[1];

        // Warunki: wewnƒÖtrz planszy, nie start/meta
        if (nx >= 0 && nx < size && ny >= 0 && ny < size && 
            !(nx === 0 && ny === 0) && !(nx === size-1 && ny === size-1)) {
            
            // KLUCZOWE: Nie wchod≈∫ na innego czerwia
            if(!board[ny][nx].worm) {
                board[ny][nx].worm = true;
                moved = true;
                break;
            }
        }
    }
    // Je≈õli nie uda≈Ço siƒô ruszyƒá (t≈Çok), zosta≈Ñ w miejscu (ew. nadpisz, ale 'moved' obs≈Çu≈ºy≈Ço 99% przypadk√≥w)
    if(!moved) board[w.y][w.x].worm = true;
  });
}

// --- OPTYMALIZACJA WY≈öWIETLANIA ---

function drawBoard() {
  // Pƒôtla po ca≈Çej planszy, ale operuje na bezpo≈õrednich referencjach DOM (bardzo szybkie)
  for (let y = 0; y < size; y++) {
    for (let x = 0; x < size; x++) {
      const cellData = board[y][x];
      const el = cellData.el;

      // Reset
      el.textContent = "";
      el.className = "cell";

      // Klasy bazowe
      if (cellData.visited) el.classList.add("visited");
      if (x === 0 && y === 0) { el.classList.add("start"); el.textContent = "A"; }
      if (x === size - 1 && y === size - 1) { el.classList.add("goal"); el.textContent = "B"; }

      // Gracz (nadpisuje resztƒô)
      if (x === playerPos.x && y === playerPos.y) {
        el.textContent = "üë£";
        el.style.color = "#fff";
      } else {
        el.style.color = ""; // reset koloru
      }
    }
  }
}

function revealWorms() {
  for (let y = 0; y < size; y++) {
    for (let x = 0; x < size; x++) {
      if (board[y][x].worm) {
        const el = board[y][x].el;
        el.classList.add("worm");
        el.textContent = "ü™±";
      }
    }
  }
}

// --- SONAR I AUDIO ---

function updateSonarAndStats() {
  // 1. Oblicz odleg≈Ço≈õƒá do najbli≈ºszego czerwia
  let minDistance = 999;
  for(let y=0; y<size; y++) {
    for(let x=0; x<size; x++) {
      if(board[y][x].worm) {
        const dist = Math.abs(playerPos.x - x) + Math.abs(playerPos.y - y);
        if(dist < minDistance) minDistance = dist;
      }
    }
  }

  // 2. UI Tekstowe i Audio
  const sonarDiv = document.getElementById("sonarOutput");
  let score = Math.max(0, 100 - steps * 2);
  document.getElementById("stats").innerText = `Kroki: ${steps} | Punktacja: ${score}`;

  if (minDistance <= 1) {
    sonarDiv.innerText = "‚ÄºÔ∏è WYKRYTO RUCH PIONOWY! (Dystans: 1)";
    sonarDiv.style.opacity = 1;
    playSonarSound(800, "sawtooth", 0.3); // Wysoki, ostry d≈∫wiƒôk
    if("vibrate" in navigator) navigator.vibrate(200); 
  } 
  else if (minDistance === 2) {
    sonarDiv.innerText = "‚ö†Ô∏è Silne wstrzƒÖsy... (Dystans: 2)";
    sonarDiv.style.opacity = 0.8;
    playSonarSound(400, "square", 0.2); // ≈öredni d≈∫wiƒôk
    if("vibrate" in navigator) navigator.vibrate(50);
  } 
  else if (minDistance === 3) {
    sonarDiv.innerText = "üîä S≈Çyszysz szum piasku (Dystans: 3)";
    sonarDiv.style.opacity = 0.5;
    playSonarSound(150, "sine", 0.1); // Niski, cichy d≈∫wiƒôk
  } 
  else {
    sonarDiv.innerText = "Stan stabilny.";
    sonarDiv.style.opacity = 0.3;
  }
}

// Syntetyzator d≈∫wiƒôku (Web Audio API) - nie wymaga plik√≥w
function playSonarSound(freq, type, vol) {
  if (!audioCtx) return;
  const osc = audioCtx.createOscillator();
  const gain = audioCtx.createGain();

  osc.type = type;
  osc.frequency.setValueAtTime(freq, audioCtx.currentTime);
  // Efekt opadania d≈∫wiƒôku (ping)
  osc.frequency.exponentialRampToValueAtTime(freq * 0.5, audioCtx.currentTime + 0.3);

  gain.gain.setValueAtTime(vol, audioCtx.currentTime);
  gain.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 0.3);

  osc.connect(gain);
  gain.connect(audioCtx.destination);

  osc.start();
  osc.stop(audioCtx.currentTime + 0.3);
}

// --- KONIEC GRY ---

function killPlayer(msg) {
  gameOver = true;
  revealWorms();
  document.body.classList.add("shake");
  document.getElementById("sonarOutput").innerText = "üíÄ " + msg;
  playSonarSound(100, "sawtooth", 0.8); // D≈∫wiƒôk ≈õmierci
}

function winGame() {
  gameOver = true;
  let score = Math.max(0, 100 - steps * 2);
  document.getElementById("helipadB").style.visibility = "visible";
  document.getElementById("sonarOutput").innerText = `üèÜ CEL OSIƒÑGNIƒòTY! Wynik: ${score}`;
  document.getElementById("sonarOutput").style.color = "#e6c47a";
  // Fanfara (prosta sekwencja)
  setTimeout(() => playSonarSound(400, "sine", 0.2), 0);
  setTimeout(() => playSonarSound(500, "sine", 0.2), 200);
  setTimeout(() => playSonarSound(800, "sine", 0.4), 400);
}

// --- AUDIO BUTTON ---
function playNarrator() {
  const audio = new Audio("Saper_Diuny.mp3");
  audio.play().catch(err => alert("Brak pliku Saper_Diuny.mp3. Gra dzia≈Ça, ale bez muzyki t≈Ça."));
}
</script>
</body>
</html>
