<!DOCTYPE html>
<html lang="pl">
<head>
<meta charset="UTF-8">
<title>Przeprawa przez Arrakis â€“ z Echem Czerwia</title>

<style>
html, body {
  margin:0;
  padding:0;
  height:100%;
  background: #000;
  color:#e6c47a;
  font-family: "Georgia", serif;
  text-align:center;
  overflow-y: auto;
  position:relative;
}

.sand {
  position:fixed;
  width:100%;
  height:100%;
  background:
    repeating-linear-gradient(
      45deg,
      rgba(230,196,122,0.2),
      rgba(230,196,122,0.2) 2px,
      rgba(0,0,0,0) 6px
    );
  animation: drift 60s linear infinite;
  pointer-events:none;
  z-index:1;
}

@keyframes drift {
  from { background-position:0 0; }
  to { background-position:1000px 1000px; }
}

.container {
  position:relative;
  z-index:2;
  padding:20px;
}

#board {
  display: inline-grid;
  margin-top: 20px;
  gap: 2px;
  min-height: 50px;
}

.cell {
  width: 32px;
  height: 32px;
  background: #222;
  border: 1px solid #e6c47a;
  display: flex;
  align-items: center;
  justify-content: center;
  cursor: pointer;
  font-weight: bold;
}

.visited { background: #444; }
.start   { background: darkgreen; }
.goal    { background: darkblue; }
.worm    { background: darkred; color:white; }

input, button {
  background:black;
  color:#e6c47a;
  border:1px solid #e6c47a;
  padding:8px;
  margin:5px;
  cursor:pointer;
}

#audioInfo {
  margin-top:10px;
  font-size:0.9em;
}
</style>
</head>

<body>

<div class="sand"></div>

<div class="container">
  <h1>Przeprawa przez Arrakis</h1>

  <p>PrzejdÅº z punktu <b>A</b> do <b>B</b> unikajÄ…c Czerwii Pustyni!</p>

  <div id="audioInfo">Kliknij gdziekolwiek aby aktywowaÄ‡ sonar ðŸ”Š</div>

  <label>Rozmiar:
    <input id="size" type="number" value="10" min="5" max="20">
  </label>

  <label>Czerwie:
    <input id="mines" type="number" value="12" min="1" max="50">
  </label>

  <button onclick="startGame()">Nowa wyprawa</button>

  <div id="board"></div>
</div>

<script>
let size, worms;
let board = [];
let gameOver = false;
let playerPos = {x:0, y:0};

/* ---- AUDIO ---- */
let audioCtx = null;
let oscillator = null;
let gainNode = null;

function initSound() {
  audioCtx = new (window.AudioContext || window.webkitAudioContext)();

  oscillator = audioCtx.createOscillator();
  gainNode = audioCtx.createGain();

  oscillator.type = "sine";
  oscillator.frequency.setValueAtTime(50, audioCtx.currentTime);

  gainNode.gain.setValueAtTime(0, audioCtx.currentTime);

  oscillator.connect(gainNode);
  gainNode.connect(audioCtx.destination);

  oscillator.start();
}

function updateSound() {
  if (!audioCtx) return;

  let minDist = Infinity;

  for (let y = 0; y < size; y++) {
    for (let x = 0; x < size; x++) {
      if (board[y][x].worm) {
        let dist = Math.abs(playerPos.x - x) + Math.abs(playerPos.y - y);
        if (dist < minDist) minDist = dist;
      }
    }
  }

  if (minDist === Infinity) minDist = size;

  let freq = 60 + (size - minDist) * 20;
  let volume = Math.max(0, (size - minDist) / size);

  oscillator.frequency.setTargetAtTime(freq, audioCtx.currentTime, 0.1);
  gainNode.gain.setTargetAtTime(volume * 0.35, audioCtx.currentTime, 0.1);
}

function stopSound() {
  if (gainNode)
    gainNode.gain.setTargetAtTime(0, audioCtx.currentTime, 0.2);
}

/* ---- GRA ---- */

function startGame() {

  const boardDiv = document.getElementById("board");

  size = parseInt(document.getElementById("size").value);
  worms = parseInt(document.getElementById("mines").value);

  if (worms >= size * size - 2) {
    alert("Za duÅ¼o czerwii!");
    return;
  }

  if (!audioCtx) initSound();
  if (audioCtx.state === "suspended") audioCtx.resume();

  board = [];
  gameOver = false;
  playerPos = {x:0, y:0};

  boardDiv.innerHTML = "";
  boardDiv.style.gridTemplateColumns = `repeat(${size}, 32px)`;

  for (let y = 0; y < size; y++) {
    board[y] = [];

    for (let x = 0; x < size; x++) {
      board[y][x] = {
        worm: false,
        visited: false
      };

      const cell = document.createElement("div");
      cell.className = "cell";
      cell.dataset.x = x;
      cell.dataset.y = y;

      cell.onclick = () => moveTo(x, y);

      boardDiv.appendChild(cell);
    }
  }

  placeWorms();
  updateSound();
  drawBoard();
}

function placeWorms() {
  let placed = 0;

  while (placed < worms) {
    let x = Math.floor(Math.random() * size);
    let y = Math.floor(Math.random() * size);

    if ((x === 0 && y === 0) || (x === size-1 && y === size-1))
      continue;

    if (!board[y][x].worm) {
      board[y][x].worm = true;
      placed++;
    }
  }
}

function isAdjacent(x, y) {
  const dx = Math.abs(playerPos.x - x);
  const dy = Math.abs(playerPos.y - y);
  return (dx + dy === 1);
}

function moveTo(x, y) {
  if (gameOver) return;
  if (!isAdjacent(x, y)) return;

  playerPos = {x, y};
  board[y][x].visited = true;

  updateSound();

  if (board[y][x].worm) {
    revealWorms();
    stopSound();
    alert("PoÅ¼arÅ‚ CiÄ™ Czerw Pustyni! ðŸ’€");
    gameOver = true;
    return;
  }

  if (x === size-1 && y === size-1) {
    stopSound();
    alert("DotarÅ‚eÅ› do celu! ZÅ‚oty Szlak zwyciÄ™Å¼yÅ‚! ðŸŽ‰");
    gameOver = true;
    drawBoard();
    return;
  }

  drawBoard();
}

function revealWorms() {
  for (let y = 0; y < size; y++) {
    for (let x = 0; x < size; x++) {
      if (board[y][x].worm) {
        const div = getCell(x, y);
        div.classList.add("worm");
        div.textContent = "ðŸª±";
      }
    }
  }
}

function drawBoard() {
  for (let y = 0; y < size; y++) {
    for (let x = 0; x < size; x++) {
      const div = getCell(x, y);
      div.className = "cell";
      div.textContent = "";

      if (board[y][x].visited)
        div.classList.add("visited");

      if (x === 0 && y === 0) {
        div.classList.add("start");
        div.textContent = "A";
      }

      if (x === size-1 && y === size-1) {
        div.classList.add("goal");
        div.textContent = "B";
      }

      if (x === playerPos.x && y === playerPos.y) {
        div.textContent = "ðŸ‘£";
      }
    }
  }
}

function getCell(x, y) {
  return document.querySelector(
    `.cell[data-x='${x}'][data-y='${y}']`
  );
}

/* odblokowanie audio po pierwszym klikniÄ™ciu */
document.addEventListener("click", () => {
  if (audioCtx && audioCtx.state === "suspended") {
    audioCtx.resume();
    document.getElementById("audioInfo").innerText =
      "Sonar czerwia aktywny ðŸ”Š";
  }
});

/* NAJWAÅ»NIEJSZA POPRAWKA â€“ start gry dopiero po zaÅ‚adowaniu strony */
window.onload = () => {
  startGame();
};
</script>

</body>
</html>
