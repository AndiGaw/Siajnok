<!DOCTYPE html>
<html lang="pl">
<head>
<meta charset="UTF-8">
<title>Skoczek pustynny ‚Äì Arrakis</title>
<style>
html, body {
    margin:0; padding:0; height:100%;
    background:#000; color:#e6c47a;
    font-family:"Georgia",serif; text-align:center;
    overflow-y:auto;
}
body.shake {animation: shake 0.1s infinite;}
@keyframes shake {
    0% {transform:translate(1px,1px);}
    25% {transform:translate(-1px,-1px);}
    50% {transform:translate(1px,-1px);}
    75% {transform:translate(-1px,1px);}
    100% {transform:translate(0,0);}
}
.sand {
    position:fixed;width:100%;height:100%;
    background:repeating-linear-gradient(45deg, rgba(230,196,122,0.2), rgba(230,196,122,0.2) 2px, rgba(0,0,0,0) 6px);
    pointer-events:none; z-index:1;
}
.container {position:relative; z-index:2; padding:20px;}
h1 {font-size:2em; margin-bottom:15px; color:#e6c47a; text-shadow:1px 1px 4px #000;}
#controls {margin-bottom:20px; display:flex; flex-direction:column; align-items:center; gap:10px;}
#controls button {
    font-size:1.3em; padding:12px 24px; background:#111; color:#e6c47a;
    border:2px solid #e6c47a; border-radius:8px;
    cursor:pointer; box-shadow:0 0 10px rgba(230,196,122,0.5);
    transition:all 0.2s;
}
#controls button:hover {background:#222; box-shadow:0 0 20px rgba(230,196,122,0.8);}
#controls label {font-size:1em; cursor:pointer; color:#e6c47a;}

#board-wrapper {display:flex; justify-content:center; align-items:flex-start; gap:20px; margin-top:20px; visibility:hidden; position:relative;}
#helipad {width:60px; height:60px; background:#444; border:2px solid #e6c47a; display:flex; align-items:center; justify-content:center; color:#e6c47a; font-weight:bold; font-size:0.9em; border-radius:8px;}
#helipad-end {width:60px; height:60px; background:#444; border:2px solid #e6c47a; display:flex; align-items:center; justify-content:center; color:#e6c47a; font-weight:bold; font-size:0.9em; border-radius:8px; position:absolute; display:none;}

#board {display:inline-grid; gap:3px;}
.cell {width:50px; height:50px; background:#222; border:2px solid #e6c47a; display:flex; align-items:center; justify-content:center; cursor:pointer; font-weight:bold; font-size:1.2em;}
.visited {background:#444;}
.start {background:darkgreen; color:#fff; font-weight:bold; text-shadow:1px 1px 2px #000;}
.goal {background:darkblue; color:#fff; font-weight:bold; text-shadow:1px 1px 2px #000;}
.worm {background:darkred; color:white;}

#stats {margin-top:10px; font-size:1.1em; font-weight:bold;}
#top10 {margin-top:20px; text-align:center; font-size:1em;}

.popup {
    position:fixed; top:50%; left:50%; transform:translate(-50%,-50%);
    background:#111; color:#e6c47a; border:3px solid #e6c47a; padding:20px;
    z-index:5; display:none; text-align:center; width:300px; border-radius:12px; box-shadow:0 0 20px rgba(230,196,122,0.6);
}
.popup h2 {margin-top:0; font-size:1.5em;}
.popup button {margin-top:10px; padding:5px 10px; cursor:pointer;}
</style>
</head>
<body>
<div class="sand"></div>
<div class="container">
    <h1>Przeprawa przez Arrakis</h1>

    <div id="controls">
        <button onclick="playNarrator()">üéôÔ∏è Narrator</button>
        <button onclick="startGame()">üèúÔ∏è Wyrusz w drogƒô przez piaski</button>
        <label><input type="checkbox" id="hardMode"> Hard Mode ‚Äì ruchome czerwie</label>
        <div id="stats">Kroki: 0 | Punktacja: 0</div>
    </div>

    <div id="board-wrapper">
        <div id="helipad">LƒÖdowisko A</div>
        <div id="board"></div>
    </div>

    <div id="helipad-end">LƒÖdowisko B</div>
    <div id="top10"></div>

    <audio id="narrator-audio"><source src="Saper_Diuny.mp3" type="audio/mpeg"></audio>

    <div id="popup-fail" class="popup">
        <h2>üíÄ Po≈ºar≈Ç Ciƒô Czerw Pustyni!</h2>
        <p>Kroki: <span id="fail-steps"></span></p>
        <button onclick="closePopup('fail')">Zamknij</button>
    </div>
    <div id="popup-win" class="popup">
        <h2>üèÜ Dotar≈Çe≈õ do B!</h2>
        <p>Kroki: <span id="win-steps"></span><br> Punktacja: <span id="win-score"></span></p>
        <button onclick="closePopup('win')">Zamknij</button>
    </div>
</div>

<script>
const size=10, worms=12;
let board=[], gameOver=false, playerPos={x:0,y:0}, steps=0, score=0;
let topScores = JSON.parse(localStorage.getItem("topScores") || "[]");
let pathCompleted=false;

// Audio
let audioCtx=null, oscillator=null, gainNode=null;
let lastVibration=0;
function initSound(){
    audioCtx = new (window.AudioContext||window.webkitAudioContext)();
    oscillator = audioCtx.createOscillator();
    gainNode = audioCtx.createGain();
    oscillator.type="sine";
    oscillator.frequency.setValueAtTime(50,audioCtx.currentTime);
    gainNode.gain.setValueAtTime(0,audioCtx.currentTime);
    oscillator.connect(gainNode);
    gainNode.connect(audioCtx.destination);
    oscillator.start();
}
function updateSoundAndShake(){
    if(!audioCtx) return;
    let minDist=Infinity;
    for(let y=0;y<size;y++)
        for(let x=0;x<size;x++)
            if(board[y][x].worm){
                let dist=Math.abs(playerPos.x-x)+Math.abs(playerPos.y-y);
                if(dist<minDist) minDist=dist;
            }
    if(minDist===Infinity) minDist=size;

    let freq=50, vol=0;
    if(minDist>=4){ freq=50; vol=0; }
    else if(minDist===3){ freq=150; vol=0.1; }
    else if(minDist===2){ freq=300; vol=0.2; }
    else if(minDist===1){ freq=500; vol=0.35; }
    else if(minDist===0){ freq=800; vol=0.5; }

    oscillator.frequency.setTargetAtTime(freq,audioCtx.currentTime,0.05);
    gainNode.gain.setTargetAtTime(vol,audioCtx.currentTime,0.05);

    if(minDist<=3 && !gameOver) document.body.classList.add("shake");
    else document.body.classList.remove("shake");

    if("vibrate" in navigator){
        const now=Date.now();
        if(now-lastVibration>150){
            lastVibration=now;
            if(minDist>=4) navigator.vibrate(10);
            else if(minDist===3) navigator.vibrate(30);
            else if(minDist===2) navigator.vibrate([60,30,60]);
            else if(minDist===1) navigator.vibrate([100,50,100]);
            else if(minDist===0) navigator.vibrate([200,100,200]);
        }
    }
}

function stopSound(){ if(gainNode) gainNode.gain.setTargetAtTime(0,audioCtx.currentTime,0.2); }

// Start gry
function startGame(){
    const boardDiv=document.getElementById("board");
    document.getElementById("board-wrapper").style.visibility="visible";
    boardDiv.innerHTML="";
    boardDiv.style.gridTemplateColumns=`repeat(${size},50px)`;
    board=[]; gameOver=false; playerPos={x:0,y:0}; steps=0; score=0; pathCompleted=false;
    document.getElementById("stats").innerText=`Kroki: 0 | Punktacja: 0`;
    document.getElementById("helipad-end").style.display="none";

    if(!audioCtx) initSound();
    if(audioCtx.state==="suspended") audioCtx.resume();

    for(let y=0;y<size;y++){
        board[y]=[];
        for(let x=0;x<size;x++){
            board[y][x]={worm:false, visited:false};
            const cell=document.createElement("div");
            cell.className="cell";
            cell.dataset.x=x;
            cell.dataset.y=y;
            cell.onclick=()=>reveal(x,y);
            boardDiv.appendChild(cell);
        }
    }

    placeWorms();
    drawBoard();
    updateSoundAndShake();
}

// Rozstawienie czerwii
function placeWorms(){
    let placed=0;
    while(placed<worms){
        let x=Math.floor(Math.random()*size);
        let y=Math.floor(Math.random()*size);
        if((x===0&&y===0)||(x===size-1&&y===size-1)) continue;
        if(!board[y][x].worm){ board[y][x].worm=true; placed++; }
    }
}

// Odkrycie pola
function reveal(x,y){
    if(gameOver) return;
    const cell=board[y][x];
    const cellDiv=getCell(x,y);
    if(cell.visited) return;

    cell.visited=true;
    steps++;
    cellDiv.classList.add("visited");

    // Trafienie czerwia
    if(cell.worm){
        cellDiv.classList.add("worm");
        cellDiv.textContent="ü™±";
        gameOver=true;
        revealAllWorms();
        stopSound();
        navigator.vibrate([300,100,300,100,600]);
        document.body.classList.remove("shake");
        document.getElementById("fail-steps").innerText=steps;
        document.getElementById("popup-fail").style.display="block";
        return;
    }

    // Przej≈õcie do B dopiero po odwiedzeniu ca≈Çej trasy
    if(x===size-1 && y===size-1){
        pathCompleted=true;
        gameOver=true;
        score=Math.max(0,100-steps*2);
        if(document.getElementById("hardMode").checked) score*=3;
        document.getElementById("win-steps").innerText=steps;
        document.getElementById("win-score").innerText=score;
        document.getElementById("popup-win").style.display="block";
        revealAllWorms();
        updateTop10();
    }

    drawBoard();
    updateStats();
    if(document.getElementById("hardMode").checked) moveWorms();
    updateSoundAndShake();
}

// Odkrycie wszystkich czerwii
function revealAllWorms(){
    for(let y=0;y<size;y++)
        for(let x=0;x<size;x++)
            if(board[y][x].worm){
                const div=getCell(x,y);
                div.classList.add("worm");
                div.textContent="ü™±";
            }
}

// Rysowanie planszy
function drawBoard(){
    for(let y=0;y<size;y++)
        for(let x=0;x<size;x++){
            const div=getCell(x,y);
            div.className="cell";
            div.textContent="";
            if(board[y][x].visited) div.classList.add("visited");
            if(x===0 && y===0){ div.classList.add("start"); div.textContent="A"; }
            if(x===size-1 && y===size-1){ div.classList.add("goal"); div.textContent="B"; }
            if(playerPos.x===x && playerPos.y===y) div.textContent="üë£";
        }
}

function getCell(x,y){ return document.querySelector(`.cell[data-x='${x}'][data-y='${y}']`); }
function updateStats(){ document.getElementById("stats").innerText=`Kroki: ${steps} | Punktacja: ${score}`; }
function playNarrator(){ const audio=document.getElementById("narrator-audio"); audio.play(); }

function moveWorms(){
    const dirs=[[0,1],[1,0],[0,-1],[-1,0]];
    for(let y=0;y<size;y++)
        for(let x=0;x<size;x++)
            if(board[y][x].worm){
                let [dx,dy]=dirs[Math.floor(Math.random()*4)];
                let nx=x+dx, ny=y+dy;
                if(nx>=0 && nx<size && ny>=0 && ny<size && !board[ny][nx].worm && (nx!==0||ny!==0) && (nx!==size-1||ny!==size-1)){
                    board[ny][nx].worm=true; board[y][x].worm=false;
                }
            }
}

function closePopup(type){ document.getElementById(`popup-${type}`).style.display="none"; }

function updateTop10(){
    let name=prompt("Wpisz sw√≥j nick:") || "Anonim";
    topScores.push({name,score});
    topScores.sort((a,b)=>b.score-b.score);
    if(topScores.length>10) topScores=topScores.slice(0,10);
    localStorage.setItem("topScores",JSON.stringify(topScores));

    const topDiv=document.getElementById("top10");
    topDiv.innerHTML="<h3>TOP 10</h3>";
    topScores.forEach((s,i)=> topDiv.innerHTML+=`${i+1}. ${s.name} ‚Äì ${s.score}<br>`);
}
</script>
</body>
</html>
