<!DOCTYPE html>
<html lang="pl">
<head>
<meta charset="UTF-8">
<title>Przeprawa przez Arrakis - Online</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
  
<style>
html, body {
  margin: 0;
  padding: 0;
  height: 100%;
  background: #000;
  color: #e6c47a;
  font-family: "Georgia", serif;
  overflow-x: hidden;
}

/* ===== NOWY SYSTEM ALERT√ìW (DIUNA STYLE) ===== */
#custom-modal {
  display: none; /* Domy≈õlnie ukryty */
  position: fixed;
  z-index: 100;
  left: 0;
  top: 0;
  width: 100%;
  height: 100%;
  background-color: rgba(0,0,0,0.85); /* Ciemne przyciemnienie t≈Ça */
  backdrop-filter: blur(2px);
  justify-content: center;
  align-items: center;
}

#modal-content {
  background-color: #111;
  border: 3px solid #e6c47a;
  box-shadow: 0 0 30px rgba(230,196,122,0.4);
  padding: 40px;
  text-align: center;
  max-width: 450px;
  width: 85%;
  max-height: 90vh;
  overflow-y: auto;
  animation: modalFadeIn 0.3s ease-out;
}

#modal-text {
  font-size: 1.5em;
  margin-bottom: 15px;
  color: #e6c47a;
  text-shadow: 0 0 10px rgba(230,196,122,0.3);
  line-height: 1.4;
}

/* Stylizacja przycisk√≥w w modalu */
.modal-btn {
  background: #222;
  color: #e6c47a;
  border: 2px solid #e6c47a;
  padding: 15px 40px;
  font-size: 1.1em;
  font-family: "Georgia", serif;
  cursor: pointer;
  transition: 0.2s;
  text-transform: uppercase;
  letter-spacing: 2px;
  margin-top: 10px;
}

.modal-btn:hover {
  background: #e6c47a;
  color: #000;
  box-shadow: 0 0 20px rgba(230,196,122,0.8);
}
.modal-btn:disabled {
    opacity: 0.5;
    cursor: wait;
}

/* --- NOWE: Styl dla pola wprowadzania nicku --- */
#nickname-input {
  display: none; /* Domy≈õlnie ukryty */
  width: 80%;
  padding: 10px;
  margin-bottom: 20px;
  background: #000;
  border: 1px solid #e6c47a;
  color: #e6c47a;
  font-family: "Georgia", serif;
  font-size: 1.2em;
  text-align: center;
}
#nickname-input:focus {
  outline: none;
  box-shadow: 0 0 15px rgba(230,196,122,0.5);
}

/* --- NOWE: STYL TABELI TOP 10 --- */
#leaderboard-table {
  display: none; /* Domy≈õlnie ukryta */
  width: 100%;
  border-collapse: collapse;
  margin-top: 10px;
  font-size: 0.9em;
}
#leaderboard-table th, #leaderboard-table td {
  border: 1px solid #554422;
  padding: 8px;
  text-align: center;
}
#leaderboard-table th {
  background-color: #221a0a;
  color: #fff;
  text-transform: uppercase;
  letter-spacing: 1px;
}
#leaderboard-table tr:nth-child(even) {
  background-color: #1a1a1a;
}
#leaderboard-table tr.highlight {
  background-color: #e6c47a;
  color: #000;
  font-weight: bold;
}  

@keyframes modalFadeIn {
  from { opacity: 0; transform: scale(0.8); }
  to { opacity: 1; transform: scale(1); }
}

/* ===== ANIMACJE DR≈ªENIA (5 POZIOM√ìW) ===== */
@keyframes shake-micro { 0%, 100% { transform: translate(0,0); } 50% { transform: translate(0.5px, 0.5px); } }
.shake-dist-3 { animation: shake-micro 0.1s infinite; }

@keyframes shake-light { 0%, 100% { transform: translate(0,0); } 25% { transform: translate(1px, 1px); } 75% { transform: translate(-1px, -1px); } }
.shake-dist-2 { animation: shake-light 0.5s infinite; }

@keyframes shake-strong { 0%, 100% { transform: translate(0,0); } 20% { transform: translate(-2px, 0); } 80% { transform: translate(2px, 0); } }
.shake-dist-1 { animation: shake-strong 0.2s infinite; }

@keyframes shake-violent { 0%, 100% { transform: translate(0,0); } 25% { transform: translate(-3px, 3px) rotate(-0.5deg); } 75% { transform: translate(3px, -3px) rotate(0.5deg); } }
.shake-dist-0 { animation: shake-violent 0.1s infinite; }

.sand {
  position: fixed;
  inset: 0;
  background: repeating-linear-gradient(45deg, rgba(230,196,122,0.2), rgba(230,196,122,0.2) 2px, rgba(0,0,0,0) 6px);
  animation: drift 60s linear infinite;
  pointer-events: none;
  z-index: 1;
}
@keyframes drift { from { background-position: 0 0; } to { background-position: 100% 100%; } }

/* ===== UI ===== */
.container { position: relative; z-index: 2; text-align: center; padding-top: 20px; }

#controls { display: flex; flex-direction: column; align-items: center; gap: 12px; margin-bottom: 10px; }
#controls button {
  font-size: 1.2em; padding: 10px 20px; width: 320px; background: #111; color: #e6c47a;
  border: 2px solid #e6c47a; border-radius: 8px; cursor: pointer; box-shadow: 0 0 10px rgba(230,196,122,0.5);
}
#controls button:hover { background: #222; box-shadow: 0 0 20px rgba(230,196,122,0.8); }

#stats { margin-top: 10px; font-size: 0.9em; font-weight: bold; }

/* ===== GAME AREA ===== */
#game-area { display: flex; align-items: flex-start; gap: 20px; margin: 20px auto; width: max-content; }

#helipadA {
  width: 120px; height: 120px; background: #111; border: 2px solid #e6c47a; border-radius: 10px;
  display: flex; align-items: center; justify-content: center; font-weight: bold; flex-shrink: 0;
}
  
#helipadB {
  width: 120px; height: 120px; background: #111; border: 2px solid #e6c47a; border-radius: 10px;
  display: flex; align-items: center; justify-content: center; font-weight: bold; flex-shrink: 0;
  visibility: hidden;   
  align-self: flex-end; 
}  

#board-wrapper { display: flex; flex-direction: column; align-items: center; min-width: calc(50px * 10 + 3px * 9); position: relative; }
#board { display: inline-grid; gap: 3px; }
#worm-map { display: inline-grid; gap: 2px; position: absolute; top: 100%; margin-top: 15px; }   

/* ===== KOM√ìRKI ===== */
.cell {
  width: 50px; 
  height: 50px; 
  background: #222; 
  border: 2px solid #e6c47a;
  
  /* --- TO JEST TA KLUCZOWA LINIJKA, KT√ìREJ BRAKUJE: --- */
  box-sizing: border-box; 
  /* ---------------------------------------------------- */

  display: flex; 
  align-items: center; 
  justify-content: center; 
  cursor: pointer; 
  font-weight: bold; 
  font-size: 1.2em;
}
  
#worm-map .cell { width: 20px; height: 20px; font-size: 0.8em; }

.visited { background: #444; }
.start   { background: darkgreen; }
.goal    { background: darkblue; }
.worm    { background: darkred; color: white; }
</style>
</head>

<body>
<div class="sand"></div>

<div class="container">
  <h1>Przeprawa przez Arrakis</h1>

  <div id="controls">
    <button id="narratorBtn" onclick="playNarrator()">üéôÔ∏è Narrator (Start)</button>
    <button onclick="startGame()">üèúÔ∏è Wyrusz do Siczy Tabr</button>
    <button onclick="showLeaderboard(null, null)">üèÜ Poka≈º Ranking</button>
    <label><input type="checkbox" id="hardMode"> Hard Mode ‚Äì ruchome czerwie</label>
  </div>

  <div id="stats">Kroki: 0 | Punktacja: 0</div>

  <div id="game-area">
    <div id="helipadA">LƒÖdowisko</div>

    <div id="board-wrapper">
      <div id="board"></div>
      <div id="worm-map"></div>
    </div>

    <div id="helipadB">Sicz Tabr</div>
  </div>
</div>

<div id="custom-modal">
  <div id="modal-content">
    <div id="modal-text">Komunikat Systemowy</div>
    
    <input type="text" id="nickname-input" placeholder="Twoje imiƒô..." maxlength="15">
    
    <table id="leaderboard-table">
        <thead>
            <tr>
                <th>#</th>
                <th>Nick</th>
                <th>PKT</th>
            </tr>
        </thead>
        <tbody id="leaderboard-body">
            </tbody>
    </table>
    
    <div style="display: flex; gap: 10px; justify-content: center;">
        <button id="modal-save-btn" class="modal-btn" onclick="submitScore()" style="display:none;">Zapisz wynik</button>
        <button id="modal-next-btn" class="modal-btn" onclick="closeModal()">Zamknij</button>
    </div>
  </div>
</div>

<script>
// =============================================================
// 1. KONFIGURACJA FIREBASE (WKLEJ DANE TUTAJ!)
// =============================================================

const firebaseConfig = {
  apiKey: "AIzaSyDgdyn19uDwBRztJh6wRvgCjP0eq_ZhVLA",
  authDomain: "siajnoq.firebaseapp.com",
  projectId: "siajnoq",
  storageBucket: "siajnoq.firebasestorage.app",
  messagingSenderId: "276340521427",
  appId: "1:276340521427:web:fd7a169822491303829726",
  measurementId: "G-15HT3559LL"
};


// Inicjalizacja backendu
let db;
try {
  if (firebaseConfig.apiKey.includes("TU_WKLEJ")) {
    console.warn("‚ö†Ô∏è Nie skonfigurowano Firebase! Ranking nie bƒôdzie dzia≈Ça≈Ç.");
  } else {
    firebase.initializeApp(firebaseConfig);
    db = firebase.firestore();
    console.log("‚úÖ Po≈ÇƒÖczono z Firebase Arrakis!");
  }
} catch (e) {
  console.error("B≈ÇƒÖd Firebase:", e);
}

// =============================================================
// 2. NOWY SYSTEM ALERT√ìW I LOGIKA RANKINGU (FIREBASE)
// =============================================================

function showCustomAlert(message) {
  const modal = document.getElementById("custom-modal");
  const text = document.getElementById("modal-text");
  
  text.innerText = message;
  // Reset widoku
  document.getElementById("nickname-input").style.display = "none";
  document.getElementById("leaderboard-table").style.display = "none";
  document.getElementById("modal-next-btn").style.display = "inline-block";
  document.getElementById("modal-next-btn").innerText = "Dalej";
  document.getElementById("modal-save-btn").style.display = "none";
  
  modal.style.display = "flex";
}

// Funkcja wywo≈Çywana po wygranej
function showVictoryInput(currentScore) {
  const modal = document.getElementById("custom-modal");
  const text = document.getElementById("modal-text");
  
  text.innerText = `Dotar≈Çe≈õ do Siczy Tabr!\nPunkty: ${currentScore}\nPodaj sw√≥j nick:`;
  
  const input = document.getElementById("nickname-input");
  input.style.display = "inline-block";
  input.value = ""; 
  
  document.getElementById("leaderboard-table").style.display = "none";
  document.getElementById("modal-next-btn").style.display = "none"; // Ukryj "Dalej", poka≈º "Zapisz"
  document.getElementById("modal-save-btn").style.display = "inline-block";
  document.getElementById("modal-save-btn").innerText = "Zapisz wynik";
  document.getElementById("modal-save-btn").disabled = false;
  
  modal.style.display = "flex";
  input.focus();
}

// Wysy≈Çanie wyniku do Firebase
async function submitScore() {
  const input = document.getElementById("nickname-input");
  const nick = input.value.trim() || "Nieznajomy";
  const btn = document.getElementById("modal-save-btn");
  
  if (!db) {
    alert("B≈ÇƒÖd: Nie skonfigurowano Firebase (brak kluczy w kodzie).");
    return;
  }

  btn.innerText = "Zapisywanie...";
  btn.disabled = true;

  try {
      // Zapis do bazy
      await db.collection("scores").add({
        nick: nick,
        points: score,
        date: firebase.firestore.FieldValue.serverTimestamp()
      });
      
      // Po sukcesie poka≈º ranking
      await showLeaderboard(nick, score);
  } catch (error) {
      console.error("B≈ÇƒÖd zapisu:", error);
      alert("Nie uda≈Ço siƒô zapisaƒá wyniku (sprawd≈∫ internet).");
      btn.innerText = "Zapisz wynik";
      btn.disabled = false;
  }
}

// Pobieranie rankingu z Firebase
async function showLeaderboard(highlightNick, highlightScore) {
  const modal = document.getElementById("custom-modal");
  const text = document.getElementById("modal-text");
  const tbody = document.getElementById("leaderboard-body");
  const table = document.getElementById("leaderboard-table");

  text.innerText = "üèÜ Globalny Ranking Diuny";

  // Ukryj input i guzik zapisu
  document.getElementById("nickname-input").style.display = "none";
  document.getElementById("modal-save-btn").style.display = "none";
  
  // Poka≈º tabelƒô ≈Çadowania
  tbody.innerHTML = "<tr><td colspan='3'>≈Åadowanie danych z Arrakis...</td></tr>";
  table.style.display = "table";
  document.getElementById("modal-next-btn").style.display = "inline-block";
  document.getElementById("modal-next-btn").innerText = "Zamknij";
  
  modal.style.display = "flex";

  if (!db) {
    tbody.innerHTML = "<tr><td colspan='3'>Brak po≈ÇƒÖczenia z bazƒÖ.</td></tr>";
    return;
  }

  try {
    const snapshot = await db.collection("scores")
                             .orderBy("points", "desc")
                             .limit(10)
                             .get();

    tbody.innerHTML = "";
    let i = 1;
    snapshot.forEach(doc => {
      const data = doc.data();
      const tr = document.createElement("tr");
      
      // Pod≈õwietlenie gracza
      if (data.points === highlightScore && data.nick === highlightNick) {
        tr.classList.add("highlight");
      }
      
      tr.innerHTML = `<td>${i}.</td><td>${escapeHtml(data.nick)}</td><td>${data.points}</td>`;
      tbody.appendChild(tr);
      i++;
    });

    if (snapshot.empty) {
        tbody.innerHTML = "<tr><td colspan='3'>Pustynia jest pusta...</td></tr>";
    }

  } catch (err) {
    console.error(err);
    tbody.innerHTML = "<tr><td colspan='3'>B≈ÇƒÖd pobierania danych.</td></tr>";
  }
}

// Zabezpieczenie przed XSS
function escapeHtml(text) {
  if (!text) return "";
  return text.replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;");
}

function closeModal() {
  document.getElementById("custom-modal").style.display = "none";
}

// =============================================================
// 3. LOGIKA GRY (BEZ ZMIAN W MECHANICE)
// =============================================================

const size = 10;
const wormsCount = 12;

let board = [];
let playerPos = {x:0, y:0};
let steps = 0;
let score = 0;
let gameOver = false;

// --- SYSTEM AUDIO (DRONE) ---
let audioCtx = null;
let bgOsc = null; 
let bgGain = null;

function initAudioContext() {
  if (!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)();
  if (audioCtx.state === 'suspended') audioCtx.resume();
}

function startBackgroundDrone() {
  initAudioContext();
  if (bgOsc) { try { bgOsc.stop(); } catch(e){} bgOsc = null; }

  bgOsc = audioCtx.createOscillator();
  bgGain = audioCtx.createGain();

  bgOsc.type = 'triangle';
  bgOsc.frequency.value = 50; 
  bgGain.gain.value = 0.05;   

  bgOsc.connect(bgGain);
  bgGain.connect(audioCtx.destination);
   
  bgOsc.start();
}

function stopBackgroundDrone() {
  if (bgOsc) {
    const now = audioCtx.currentTime;
    bgGain.gain.exponentialRampToValueAtTime(0.001, now + 1);
    bgOsc.stop(now + 1);
    bgOsc = null;
  }
}

function updateDroneSound(distance) {
  if (!bgOsc || !audioCtx) return;
  const now = audioCtx.currentTime;
  let targetFreq, targetVol;

  if (distance === 0) { targetFreq = 50; targetVol = 0; } 
  else if (distance === 1) { targetFreq = 400; targetVol = 0.35; } 
  else if (distance === 2) { targetFreq = 200; targetVol = 0.20; } 
  else if (distance === 3) { targetFreq = 100; targetVol = 0.10; } 
  else { targetFreq = 50; targetVol = 0.05; }

  bgOsc.frequency.linearRampToValueAtTime(targetFreq, now + 0.3);
  bgGain.gain.linearRampToValueAtTime(targetVol, now + 0.3);
}

// --- LOGIKA GRY ---

function startGame() {
  initAudioContext();
  startBackgroundDrone(); 

  const boardDiv = document.getElementById("board");
  const wormDiv  = document.getElementById("worm-map");

  board = [];
  gameOver = false;
  playerPos = {x:0, y:0};
  steps = 0;
  score = 0;
   
  document.getElementById("stats").innerText = "Kroki: 0 | Punktacja: 0";
  document.body.className = "";
  document.getElementById("helipadB").style.visibility = "hidden";

  boardDiv.innerHTML = "";
  wormDiv.innerHTML = "";
  boardDiv.style.gridTemplateColumns = `repeat(${size}, 1fr)`; // Zmienione na 1fr
  wormDiv.style.gridTemplateColumns  = `repeat(${size}, 20px)`;

  for (let y = 0; y < size; y++) {
    board[y] = [];
    for (let x = 0; x < size; x++) {
      board[y][x] = { worm:false, visited:false };

      const cell = document.createElement("div");
      cell.className = "cell";
      cell.dataset.x = x;
      cell.dataset.y = y;
      cell.onclick = () => moveTo(x,y);
      boardDiv.appendChild(cell);

      const wcell = document.createElement("div");
      wcell.className = "cell";
      wcell.dataset.x = x;
      wcell.dataset.y = y;
      wormDiv.appendChild(wcell);
    }
  }

  placeWorms();
  updateWormMap();
  drawBoard();
  checkProximity(0,0);
}

function placeWorms() {
  let placed = 0;
  while (placed < wormsCount) {
    let x = Math.floor(Math.random() * size);
    let y = Math.floor(Math.random() * size);
    if ((x === 0 && y === 0) || (x === size-1 && y === size-1)) continue;
    if (!board[y][x].worm) {
      board[y][x].worm = true;
      placed++;
    }
  }
}

function moveWorms() {
  if (!document.getElementById("hardMode").checked) return;
  let newBoard = board.map(row => row.map(cell => ({...cell, worm:false})));
  for (let y = 0; y < size; y++) {
    for (let x = 0; x < size; x++) {
      if (board[y][x].worm) {
        const dirs = [[0,0],[0,-1],[0,1],[-1,0],[1,0]];
        const [dx,dy] = dirs[Math.floor(Math.random()*dirs.length)];
        let nx = x+dx, ny = y+dy;
        if (nx>=0 && nx<size && ny>=0 && ny<size &&
            !(nx===0 && ny===0) && !(nx===size-1 && ny===size-1)) {
          newBoard[ny][nx].worm = true;
        } else {
          newBoard[y][x].worm = true;
        }
      }
    }
  }
  for (let y = 0; y < size; y++) {
      for (let x = 0; x < size; x++) {
          board[y][x].worm = newBoard[y][x].worm;
      }
  }
  updateWormMap();
}

function updateWormMap() {
  const wormDiv = document.getElementById("worm-map");
  for (let y = 0; y < size; y++) {
    for (let x = 0; x < size; x++) {
      const cell = wormDiv.querySelector(`.cell[data-x='${x}'][data-y='${y}']`);
      if (x === playerPos.x && y === playerPos.y) {
          cell.textContent = "üë£";
      } else {
          cell.textContent = board[y][x].worm ? "ü™±" : "";
      }
    }
  }
}

function isAdjacent(x,y) {
  return Math.abs(playerPos.x-x)+Math.abs(playerPos.y-y)===1;
}

function moveTo(x,y) {
  if(gameOver || !isAdjacent(x,y)) return;
  initAudioContext();

  playerPos = {x,y};
  steps++;
  board[y][x].visited = true;

  // --- MODYFIKACJA PUNKTACJI ---
  let baseScore = Math.max(0, 100 - steps * 2);
  let isHardMode = document.getElementById("hardMode").checked;
  score = isHardMode ? baseScore * 4 : baseScore;
   
  document.getElementById("stats").innerText = `Kroki: ${steps} | Punktacja: ${score}`;

  if (board[y][x].worm) {
    handleDeath();
    return;
  }

  moveWorms();

  if (board[playerPos.y][playerPos.x].worm) {
    handleDeath();
    return;
  }

  checkProximity(x, y);

  drawBoard();
  updateWormMap();

  if (x===size-1 && y===size-1) {
    revealWorms(); 
    document.getElementById("helipadB").style.visibility = "visible";
    stopBackgroundDrone();

    document.body.className = "";
    gameOver = true;
    
    // ZMIANA: Pokazujemy okno zapisu online
    showVictoryInput(score);
  }
}

function handleDeath() {
  applyFeedback(0);
  revealWorms();
  updateWormMap();
  stopBackgroundDrone(); 
  playTone(100, "sawtooth", 0.5); 
   
  setTimeout(() => showCustomAlert("Po≈ºar≈Ç Ciƒô Czerw Pustyni!\nKoniec gry."), 100);
  gameOver = true;
}

function checkProximity(px, py) {
  let minDistance = 999;
  for(let y=0; y<size; y++) {
    for(let x=0; x<size; x++) {
      if(board[y][x].worm) {
        const dist = Math.abs(px - x) + Math.abs(py - y);
        if(dist < minDistance) minDistance = dist;
      }
    }
  }
  updateDroneSound(minDistance);
  applyFeedback(minDistance);
}

function applyFeedback(distance) {
  document.body.className = "";
  if (distance === 0) document.body.classList.add("shake-dist-0");
  else if (distance === 1) document.body.classList.add("shake-dist-1");
  else if (distance === 2) document.body.classList.add("shake-dist-2");
  else if (distance === 3) document.body.classList.add("shake-dist-3");
}

function playTone(freq, type, vol) {
  if (!audioCtx) return;
  const osc = audioCtx.createOscillator();
  const gain = audioCtx.createGain();
  osc.type = type;
  osc.frequency.setValueAtTime(freq, audioCtx.currentTime);
  gain.gain.setValueAtTime(vol, audioCtx.currentTime);
  gain.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 0.5);
  osc.connect(gain);
  gain.connect(audioCtx.destination);
  osc.start();
  osc.stop(audioCtx.currentTime + 0.5);
}

function drawBoard() {
  for(let y=0;y<size;y++){
    for(let x=0;x<size;x++){
      const cell = document.querySelector(`.cell[data-x='${x}'][data-y='${y}']`);
      cell.className="cell";
      cell.textContent="";
      if(board[y][x].visited) cell.classList.add("visited");
      if(x===0 && y===0){ cell.classList.add("start"); cell.textContent="A"; }
      if(x===size-1 && y===size-1){ cell.classList.add("goal"); cell.textContent="B"; }
      if(x===playerPos.x && y===playerPos.y) cell.textContent="üë£";
    }
  }
}

function revealWorms() {
  for(let y=0;y<size;y++){
    for(let x=0;x<size;x++){
      if(board[y][x].worm){
        const cell = document.querySelector(`.cell[data-x='${x}'][data-y='${y}']`);
        cell.classList.add("worm");
        cell.textContent="ü™±";
      }
    }
  }
}

let narratorAudio = null;
function playNarrator() {
  const btn = document.getElementById("narratorBtn");
  if (!narratorAudio) {
    narratorAudio = new Audio("Saper_Diuny.mp3");
    narratorAudio.addEventListener('ended', () => {
       btn.innerText = "üéôÔ∏è Narrator (Start)";
       narratorAudio.currentTime = 0;
    });
  }
  if (narratorAudio.paused) {
    narratorAudio.play().then(() => {
      btn.innerText = "‚è∏Ô∏è Narrator (Pauza)";
    }).catch(err => {
      showCustomAlert("B≈ÇƒÖd audio:\nBrak pliku Saper_Diuny.mp3!");
    });
  } else {
    narratorAudio.pause();
    btn.innerText = "‚ñ∂Ô∏è Narrator (Wzn√≥w)";
  }
}
</script>
</body>
</html>
