<!DOCTYPE html>
<html lang="pl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
<title>Siajnoq - Pustynna Przeprawa</title>

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

<style>
/* --- STYLE GRAFICZNE (CSS) --- */
html, body {
  margin: 0;
  padding: 0;
  height: 100%;
  background: #000;
  color: #e6c47a;
  font-family: "Georgia", serif;
  overflow-x: hidden;
  touch-action: manipulation; /* Zapobiega zoomowaniu na telefonach */
}

/* OKNO MODALNE (Ranking i komunikaty) */
#custom-modal {
  display: none;
  position: fixed;
  z-index: 100;
  left: 0;
  top: 0;
  width: 100%;
  height: 100%;
  background-color: rgba(0,0,0,0.85);
  backdrop-filter: blur(3px);
  justify-content: center;
  align-items: center;
}

#modal-content {
  background-color: #111;
  border: 3px solid #e6c47a;
  box-shadow: 0 0 30px rgba(230,196,122,0.4);
  padding: 30px;
  text-align: center;
  width: 90%;
  max-width: 450px;
  max-height: 85vh;
  overflow-y: auto;
  animation: modalFadeIn 0.3s ease-out;
}

#modal-text {
  font-size: 1.4em;
  margin-bottom: 20px;
  color: #e6c47a;
  line-height: 1.4;
}

.modal-btn {
  background: #222;
  color: #e6c47a;
  border: 2px solid #e6c47a;
  padding: 12px 25px;
  font-size: 1em;
  font-family: "Georgia", serif;
  cursor: pointer;
  margin-top: 15px;
  text-transform: uppercase;
  letter-spacing: 1px;
}
.modal-btn:hover { background: #e6c47a; color: #000; }
.modal-btn:disabled { opacity: 0.5; cursor: not-allowed; }

#nickname-input {
  display: none; 
  width: 70%;
  padding: 10px;
  margin-bottom: 15px;
  background: #000;
  border: 1px solid #e6c47a;
  color: #e6c47a;
  font-size: 1.2em;
  text-align: center;
}

/* TABELA RANKINGU */
#leaderboard-table {
  display: none;
  width: 100%;
  border-collapse: collapse;
  margin-top: 10px;
  font-size: 0.9em;
}
#leaderboard-table th, #leaderboard-table td {
  border: 1px solid #554422;
  padding: 8px;
  text-align: center;
}
#leaderboard-table th { background-color: #221a0a; color: #fff; }
#leaderboard-table tr:nth-child(even) { background-color: #1a1a1a; }
#leaderboard-table tr.highlight { background-color: #e6c47a; color: #000; font-weight: bold; }

@keyframes modalFadeIn { from { opacity: 0; transform: scale(0.9); } to { opacity: 1; transform: scale(1); } }

/* ELEMENTY GRY */
.container { position: relative; z-index: 2; text-align: center; padding-top: 20px; }

#controls { display: flex; flex-direction: column; align-items: center; gap: 10px; margin-bottom: 10px; }
#controls button {
  font-size: 1.1em; padding: 10px; width: 300px; background: #111; color: #e6c47a;
  border: 1px solid #e6c47a; border-radius: 5px; cursor: pointer;
}
#stats { margin-top: 5px; font-weight: bold; font-size: 0.9em; }

#game-area { display: flex; flex-direction: column; align-items: center; margin: 15px auto; }
#board-wrapper { position: relative; display: inline-block; }
#board { display: grid; gap: 2px; background: #332200; border: 2px solid #e6c47a; padding: 2px; }

.cell {
  width: 35px; height: 35px; /* Mniejsze kafelki dla lepszego dzia≈Çania na mobile */
  background: #222; 
  display: flex; align-items: center; justify-content: center; 
  cursor: pointer; font-size: 1.2em; user-select: none;
}
/* Responsywno≈õƒá dla wiƒôkszych ekran√≥w */
@media (min-width: 600px) {
  .cell { width: 45px; height: 45px; }
}

.visited { background: #3a3a3a; }
.start { background: #1b5e20; color: white; font-size: 0.8em; }
.goal { background: #0d47a1; color: white; font-size: 0.8em; }
.worm { background: #b71c1c; color: white; }
.player { background: #e6c47a; color: black; border-radius: 50%; width: 70%; height: 70%; }

/* EFEKTY PUSTYNI (Piasek w tle) */
.sand {
  position: fixed; inset: 0;
  background: repeating-linear-gradient(45deg, rgba(230,196,122,0.15), rgba(230,196,122,0.15) 2px, rgba(0,0,0,0) 6px);
  animation: drift 60s linear infinite; pointer-events: none; z-index: 1;
}
@keyframes drift { from { background-position: 0 0; } to { background-position: 100% 100%; } }

/* TRZƒòSIENIE EKRANU */
@keyframes shake0 { 0%, 100% { transform: translate(0,0); } 25% { transform: translate(-3px, 3px); } 75% { transform: translate(3px, -3px); } }
.shake-violent { animation: shake0 0.2s infinite; }
@keyframes shake1 { 0%, 100% { transform: translate(0,0); } 50% { transform: translate(2px, 0); } }
.shake-strong { animation: shake1 0.2s infinite; }
@keyframes shake2 { 0%, 100% { transform: translate(0,0); } 50% { transform: translate(1px, 1px); } }
.shake-light { animation: shake2 0.5s infinite; }
</style>
</head>

<body>
<div class="sand"></div>

<div class="container">
  <h2 style="margin: 10px 0;">Siajnoq</h2>
  
  <div id="controls">
    <button id="narratorBtn" onclick="playNarrator()">üéôÔ∏è Narrator</button>
    <button onclick="startGame()">üèúÔ∏è Nowa Wyprawa</button>
    <button onclick="showLeaderboard(null, null)">üèÜ Globalny Ranking</button>
    <label style="font-size:0.9em"><input type="checkbox" id="hardMode"> Tryb Hard (Czerw siƒô rusza)</label>
  </div>

  <div id="stats">Kroki: 0 | Wynik: 0</div>

  <div id="game-area">
    <div id="board-wrapper">
      <div id="board"></div>
    </div>
  </div>
</div>

<div id="custom-modal">
  <div id="modal-content">
    <div id="modal-text">Komunikat</div>
    
    <input type="text" id="nickname-input" placeholder="Wpisz sw√≥j nick" maxlength="12">
    
    <table id="leaderboard-table">
        <thead><tr><th>#</th><th>Nick</th><th>PKT</th></tr></thead>
        <tbody id="leaderboard-body"></tbody>
    </table>
    
    <div style="display:flex; justify-content:center; gap:10px;">
        <button id="modal-save-btn" class="modal-btn" onclick="submitScore()" style="display:none;">Zapisz wynik</button>
        <button id="modal-close-btn" class="modal-btn" onclick="closeModal()">Zamknij</button>
    </div>
  </div>
</div>

<script>
// =============================================================
// 1. KONFIGURACJA FIREBASE (TUTAJ WKLEJASZ SWOJE DANE!)
// =============================================================

// ‚ö†Ô∏è UWAGA: Skopiuj zawarto≈õƒá "firebaseConfig" ze strony Firebase i wklej poni≈ºej:
  const firebaseConfig = {
    apiKey: "AIzaSyDgdyn19uDwBRztJh6wRvgCjP0eq_ZhVLA",
    authDomain: "siajnoq.firebaseapp.com",
    projectId: "siajnoq",
    storageBucket: "siajnoq.firebasestorage.app",
    messagingSenderId: "276340521427",
    appId: "1:276340521427:web:fd7a169822491303829726",
    measurementId: "G-15HT3559LL"
  };


// Inicjalizacja backendu
let db;
try {
  // Sprawdzamy, czy u≈ºytkownik podmieni≈Ç klucze
  if (firebaseConfig.apiKey.includes("TU_WKLEJ")) {
    console.warn("‚ö†Ô∏è Nie skonfigurowano Firebase! Ranking nie bƒôdzie dzia≈Ça≈Ç.");
  } else {
    firebase.initializeApp(firebaseConfig);
    db = firebase.firestore();
    console.log("‚úÖ Po≈ÇƒÖczono z Firebase Siajnoq!");
  }
} catch (e) {
  console.error("B≈ÇƒÖd Firebase:", e);
}

// =============================================================
// 2. LOGIKA RANKINGU (GLOBALNA)
// =============================================================

// Funkcja zapisu wyniku
async function submitScore() {
  const input = document.getElementById("nickname-input");
  const nick = input.value.trim();
  
  if (!nick) { alert("Musisz podaƒá nick!"); return; }
  if (!db) { alert("B≈ÇƒÖd: Brak po≈ÇƒÖczenia z bazƒÖ (≈∫le wklejony config)."); return; }

  const btn = document.getElementById("modal-save-btn");
  btn.disabled = true;
  btn.innerText = "Zapisywanie...";

  try {
    await db.collection("scores").add({
      nick: nick,
      points: score,
      date: firebase.firestore.FieldValue.serverTimestamp()
    });
    // Po zapisie od razu poka≈º ranking z pod≈õwietleniem
    await showLeaderboard(nick, score);
  } catch (error) {
    console.error("B≈ÇƒÖd zapisu:", error);
    alert("Nie uda≈Ço siƒô po≈ÇƒÖczyƒá z serwerem.");
    btn.disabled = false;
    btn.innerText = "Zapisz wynik";
  }
}

// Funkcja pobierania rankingu
async function showLeaderboard(highlightNick, highlightScore) {
  const modal = document.getElementById("custom-modal");
  const text = document.getElementById("modal-text");
  const tbody = document.getElementById("leaderboard-body");
  const table = document.getElementById("leaderboard-table");

  text.innerText = "üèÜ Ranking Pustynny";
  document.getElementById("nickname-input").style.display = "none";
  document.getElementById("modal-save-btn").style.display = "none";
  document.getElementById("modal-close-btn").style.display = "none"; // Ukryj guzik na czas ≈Çadowania
  
  tbody.innerHTML = "<tr><td colspan='3'>≈Åadowanie danych...</td></tr>";
  table.style.display = "table";
  modal.style.display = "flex";

  if (!db) {
    tbody.innerHTML = "<tr><td colspan='3'>Brak konfiguracji bazy!</td></tr>";
    document.getElementById("modal-close-btn").style.display = "inline-block";
    return;
  }

  try {
    const snapshot = await db.collection("scores")
                             .orderBy("points", "desc")
                             .limit(10)
                             .get();

    tbody.innerHTML = "";
    let i = 1;
    snapshot.forEach(doc => {
      const data = doc.data();
      const tr = document.createElement("tr");
      // Pod≈õwietl obecny wynik gracza
      if (data.points === highlightScore && data.nick === highlightNick) {
        tr.classList.add("highlight");
      }
      tr.innerHTML = `<td>${i}.</td><td>${escapeHtml(data.nick)}</td><td>${data.points}</td>`;
      tbody.appendChild(tr);
      i++;
    });

    if (snapshot.empty) tbody.innerHTML = "<tr><td colspan='3'>Pustynia jest pusta...</td></tr>";

  } catch (err) {
    console.error(err);
    tbody.innerHTML = "<tr><td colspan='3'>B≈ÇƒÖd pobierania danych.</td></tr>";
  }
  
  document.getElementById("modal-close-btn").style.display = "inline-block";
}

function escapeHtml(text) {
  if (!text) return "";
  return text.replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;");
}

function closeModal() {
  document.getElementById("custom-modal").style.display = "none";
}

// =============================================================
// 3. LOGIKA GRY (MECHANIKA)
// =============================================================

const size = 10;
const wormsCount = 13;
let board = [];
let playerPos = {x:0, y:0};
let steps = 0;
let score = 0;
let gameOver = false;
let audioCtx = null, droneOsc = null, droneGain = null;

function initAudio() {
  if (!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)();
  if (audioCtx.state === 'suspended') audioCtx.resume();
}

// D≈∫wiƒôk t≈Ça (Drone)
function startDrone() {
  initAudio();
  if (droneOsc) stopDrone();
  droneOsc = audioCtx.createOscillator();
  droneGain = audioCtx.createGain();
  droneOsc.type = 'triangle';
  droneOsc.frequency.value = 50; 
  droneGain.gain.value = 0.05;
  droneOsc.connect(droneGain);
  droneGain.connect(audioCtx.destination);
  droneOsc.start();
}

function stopDrone() {
  if (droneOsc) {
    droneGain.gain.setTargetAtTime(0, audioCtx.currentTime, 0.5);
    droneOsc.stop(audioCtx.currentTime + 1);
    droneOsc = null;
  }
}

function updateDrone(dist) {
  if (!droneOsc) return;
  const now = audioCtx.currentTime;
  let freq = 50, vol = 0.05;
  
  if (dist === 1) { freq = 200; vol = 0.3; }
  else if (dist === 2) { freq = 120; vol = 0.15; }
  else if (dist === 3) { freq = 80; vol = 0.1; }
  
  droneOsc.frequency.linearRampToValueAtTime(freq, now + 0.5);
  droneGain.gain.linearRampToValueAtTime(vol, now + 0.5);
}

// Start Gry
function startGame() {
  initAudio();
  startDrone();
  
  board = [];
  gameOver = false;
  playerPos = {x:0, y:0};
  steps = 0;
  score = 0;
  
  updateUI();
  document.body.className = "";
  
  const boardEl = document.getElementById("board");
  boardEl.innerHTML = "";
  boardEl.style.gridTemplateColumns = `repeat(${size}, 1fr)`;

  // Generowanie planszy
  for (let y = 0; y < size; y++) {
    board[y] = [];
    for (let x = 0; x < size; x++) {
      board[y][x] = { worm: false, visited: false };
      const cell = document.createElement("div");
      cell.className = "cell";
      cell.dataset.x = x; 
      cell.dataset.y = y;
      cell.onclick = () => movePlayer(x, y);
      
      if (x===0 && y===0) { cell.classList.add("start"); cell.innerText = "A"; }
      if (x===size-1 && y===size-1) { cell.classList.add("goal"); cell.innerText = "B"; }
      
      boardEl.appendChild(cell);
    }
  }

  // Rozmieszczenie czerwi
  let placed = 0;
  while (placed < wormsCount) {
    let x = Math.floor(Math.random() * size);
    let y = Math.floor(Math.random() * size);
    // Nie na starcie i nie na mecie
    if ((x===0 && y===0) || (x===size-1 && y===size-1)) continue;
    if (!board[y][x].worm) {
      board[y][x].worm = true;
      placed++;
    }
  }

  drawPlayer();
  checkSensors();
}

function drawPlayer() {
  document.querySelectorAll(".cell").forEach(c => {
    c.innerHTML = "";
    c.classList.remove("visited", "worm");
    if (c.classList.contains("start")) c.innerText = "A";
    if (c.classList.contains("goal")) c.innerText = "B";
    
    let x = parseInt(c.dataset.x);
    let y = parseInt(c.dataset.y);
    
    if (board[y][x].visited) c.classList.add("visited");
    if (gameOver && board[y][x].worm) {
        c.classList.add("worm");
        c.innerText = "ü™±";
    }
    if (x === playerPos.x && y === playerPos.y && !gameOver) {
        c.innerHTML = "<div class='player'></div>";
    }
  });
}

function movePlayer(x, y) {
  if (gameOver) return;
  
  // Sprawd≈∫ czy ruch jest o 1 pole (g√≥ra/d√≥≈Ç/lewo/prawo)
  const dist = Math.abs(playerPos.x - x) + Math.abs(playerPos.y - y);
  if (dist !== 1) return;

  initAudio();
  steps++;
  playerPos = {x, y};
  board[y][x].visited = true;
  
  // Oblicz punkty
  let basePoints = Math.max(0, 100 - steps);
  if (document.getElementById("hardMode").checked) {
      score = basePoints * 5;
      moveWorms(); // W trybie hard czerwie siƒô ruszajƒÖ
  } else {
      score = basePoints;
  }
  
  updateUI();

  // Sprawdzenie kolizji
  if (board[y][x].worm) {
      endGame(false);
      return;
  }

  // Sprawdzenie wygranej
  if (x === size-1 && y === size-1) {
      endGame(true);
      return;
  }

  checkSensors();
  drawPlayer();
}

function moveWorms() {
    // Prosta logika ruchu czerwi (losowo o 1 pole)
    let newBoardState = board.map(row => row.map(cell => cell.worm));
    
    for(let y=0; y<size; y++) {
        for(let x=0; x<size; x++) {
            if (board[y][x].worm) {
                // Szansa 30% na ruch
                if (Math.random() > 0.3) continue;
                
                const dirs = [[0,1], [0,-1], [1,0], [-1,0]];
                const dir = dirs[Math.floor(Math.random()*dirs.length)];
                let nx = x + dir[0];
                let ny = y + dir[1];
                
                if (nx>=0 && nx<size && ny>=0 && ny<size && 
                    !(nx===0 && ny===0) && !(nx===size-1 && ny===size-1)) {
                    // Przesu≈Ñ
                    newBoardState[y][x] = false;
                    newBoardState[ny][nx] = true;
                }
            }
        }
    }
    // Aktualizuj planszƒô
    for(let y=0; y<size; y++) 
        for(let x=0; x<size; x++) 
            board[y][x].worm = newBoardState[y][x];
}

function checkSensors() {
  let minDist = 99;
  for (let y=0; y<size; y++) {
    for (let x=0; x<size; x++) {
      if (board[y][x].worm) {
        const d = Math.abs(playerPos.x - x) + Math.abs(playerPos.y - y);
        if (d < minDist) minDist = d;
      }
    }
  }
  
  updateDrone(minDist);
  
  // Efekty wizualne
  document.body.className = "";
  if (minDist === 1) document.body.classList.add("shake-violent");
  else if (minDist === 2) document.body.classList.add("shake-strong");
  else if (minDist === 3) document.body.classList.add("shake-light");
}

function endGame(win) {
  gameOver = true;
  stopDrone();
  drawPlayer(); // Ods≈Ço≈Ñ czerwie
  document.body.className = "";

  const modal = document.getElementById("custom-modal");
  const text = document.getElementById("modal-text");
  
  document.getElementById("leaderboard-table").style.display = "none";
  document.getElementById("modal-close-btn").style.display = "inline-block";

  if (win) {
    text.innerText = `Uda≈Ço siƒô! Dotar≈Çe≈õ do Siczy Tabr.\nPunkty: ${score}`;
    document.getElementById("nickname-input").style.display = "inline-block";
    document.getElementById("modal-save-btn").style.display = "inline-block";
    playTone(600, "sine");
  } else {
    text.innerText = "Zjad≈Ç Ciƒô Czerw Pustyni!\nKoniec gry.";
    document.getElementById("nickname-input").style.display = "none";
    document.getElementById("modal-save-btn").style.display = "none";
    playTone(100, "sawtooth");
  }
  
  modal.style.display = "flex";
}

function updateUI() {
  document.getElementById("stats").innerText = `Kroki: ${steps} | Wynik: ${score}`;
}

// Audio pomocnicze
function playTone(freq, type) {
  if (!audioCtx) return;
  const o = audioCtx.createOscillator();
  const g = audioCtx.createGain();
  o.type = type;
  o.frequency.setValueAtTime(freq, audioCtx.currentTime);
  g.gain.setValueAtTime(0.1, audioCtx.currentTime);
  g.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 0.5);
  o.connect(g);
  g.connect(audioCtx.destination);
  o.start();
  o.stop(audioCtx.currentTime + 0.5);
}

let narratorAudio = null;
function playNarrator() {
  const btn = document.getElementById("narratorBtn");
  if (!narratorAudio) {
    narratorAudio = new Audio("Saper_Diuny.mp3");
    narratorAudio.onended = () => btn.innerText = "üéôÔ∏è Narrator";
  }
  
  if (narratorAudio.paused) {
    narratorAudio.play().catch(e => alert("Brak pliku Saper_Diuny.mp3 w folderze!"));
    btn.innerText = "‚è∏Ô∏è Stop";
  } else {
    narratorAudio.pause();
    narratorAudio.currentTime = 0;
    btn.innerText = "üéôÔ∏è Narrator";
  }
}
</script>
</body>
</html>
