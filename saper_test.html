<!DOCTYPE html>
<html lang="pl">
<head>
<meta charset="UTF-8">
<title>Przeprawa przez Arrakis ‚Äì 5 Poziom√≥w Zagro≈ºenia</title>

<style>
html, body {
  margin: 0;
  padding: 0;
  height: 100%;
  background: #000;
  color: #e6c47a;
  font-family: "Georgia", serif;
  overflow-x: hidden;
}

/* ===== ANIMACJE DR≈ªENIA (5 POZIOM√ìW) ===== */

/* Dystans 3: Mikro-drgania (subtelny niepok√≥j) */
@keyframes shake-micro {
  0%, 100% { transform: translate(0,0); }
  50% { transform: translate(0.5px, 0.5px); }
}
.shake-dist-3 { animation: shake-micro 0.1s infinite; }

/* Dystans 2: Lekkie drgania (ostrze≈ºenie) */
@keyframes shake-light {
  0%, 100% { transform: translate(0,0); }
  25% { transform: translate(1px, 1px); }
  75% { transform: translate(-1px, -1px); }
}
.shake-dist-2 { animation: shake-light 0.5s infinite; }

/* Dystans 1: Silne drgania (zagro≈ºenie) */
@keyframes shake-strong {
  0%, 100% { transform: translate(0,0); }
  20% { transform: translate(-2px, 0); }
  40% { transform: translate(2px, 0); }
  60% { transform: translate(-2px, 0); }
  80% { transform: translate(2px, 0); }
}
.shake-dist-1 { animation: shake-strong 0.2s infinite; }

/* Dystans 0: Kolizja (≈õmierƒá) */
@keyframes shake-violent {
  0% { transform: translate(0, 0) rotate(0deg); }
  25% { transform: translate(-3px, 3px) rotate(-2deg); }
  50% { transform: translate(3px, -3px) rotate(2deg); }
  75% { transform: translate(-3px, -3px) rotate(-2deg); }
  100% { transform: translate(0, 0) rotate(0deg); }
}
.shake-dist-0 { animation: shake-violent 0.1s infinite; }


.sand {
  position: fixed;
  inset: 0;
  background: repeating-linear-gradient(
    45deg,
    rgba(230,196,122,0.2),
    rgba(230,196,122,0.2) 2px,
    rgba(0,0,0,0) 6px
  );
  animation: drift 60s linear infinite;
  pointer-events: none;
  z-index: 1;
}

/* ===== UI ===== */
.container {
  position: relative;
  z-index: 2;
  text-align: center;
  padding-top: 20px;
}

#controls {
  display: flex;
  flex-direction: column;
  align-items: center;
  gap: 12px;
  margin-bottom: 10px;
}
#controls button {
  font-size: 1.2em;
  padding: 10px 20px;
  width: 320px;
  background: #111;
  color: #e6c47a;
  border: 2px solid #e6c47a;
  border-radius: 8px;
  cursor: pointer;
  box-shadow: 0 0 10px rgba(230,196,122,0.5);
}
#controls button:hover {
  background: #222;
  box-shadow: 0 0 20px rgba(230,196,122,0.8);
}

#stats {
  margin-top: 10px;
  font-size: 0.9em;
  font-weight: bold;
}

/* ===== GAME AREA ===== */
#game-area {
  display: flex;
  align-items: flex-start;
  gap: 20px;
  margin: 20px auto;
  width: max-content; 
}

#helipadA, #helipadB {
  width: 120px;
  height: 120px;
  background: #111;
  border: 2px solid #e6c47a;
  border-radius: 10px;
  display: flex;
  align-items: center;
  justify-content: center;
  font-weight: bold;
  flex-shrink: 0;
}
#helipadB { visibility: hidden; }

#board-wrapper {
  display: flex;
  flex-direction: column;
  align-items: center;
  min-width: calc(50px * 10 + 3px * 9);
}

#board {
  display: inline-grid;
  gap: 3px;
}
#worm-map {
  margin-top: 15px;
  display: inline-grid;
  gap: 2px;
}

/* ===== KOM√ìRKI ===== */
.cell {
  width: 50px;
  height: 50px;
  background: #222;
  border: 2px solid #e6c47a;
  display: flex;
  align-items: center;
  justify-content: center;
  cursor: pointer;
  font-weight: bold;
  font-size: 1.2em;
}
#worm-map .cell {
  width: 20px;
  height: 20px;
  font-size: 0.8em;
}

.visited { background: #444; }
.start   { background: darkgreen; }
.goal    { background: darkblue; }
.worm    { background: darkred; color: white; }
</style>
</head>

<body>
<div class="sand"></div>

<div class="container">
  <h1>Przeprawa przez Arrakis</h1>
  <p>System wczesnego ostrzegania (5 poziom√≥w zagro≈ºenia)</p>

  <div id="controls">
    <button onclick="playNarrator()">üéôÔ∏è Narrator</button>
    <button onclick="startGame()">üèúÔ∏è Uruchom systemy i ruszaj</button>
    <label><input type="checkbox" id="hardMode"> Hard Mode ‚Äì ruchome czerwie</label>
  </div>

  <div id="stats">Kroki: 0 | Punktacja: 0</div>

  <div id="game-area">
    <div id="helipadA">LƒÖdowisko A</div>

    <div id="board-wrapper">
      <div id="board"></div>
      <div id="worm-map"></div>
    </div>

    <div id="helipadB">LƒÖdowisko B</div>
  </div>
</div>

<script>
// --- KONFIGURACJA ---
const size = 10;
const wormsCount = 12;

// --- ZMIENNE STANU ---
let board = [];
let playerPos = {x:0, y:0};
let steps = 0;
let score = 0;
let gameOver = false;

// --- SYSTEM AUDIO (DRONE) ---
let audioCtx = null;
let bgOsc = null;  // Oscylator t≈Ça
let bgGain = null; // G≈Ço≈õno≈õƒá t≈Ça

function initAudioContext() {
  if (!audioCtx) {
    audioCtx = new (window.AudioContext || window.webkitAudioContext)();
  }
  if (audioCtx.state === 'suspended') {
    audioCtx.resume();
  }
}

function startBackgroundDrone() {
  initAudioContext();
  if (bgOsc) { try { bgOsc.stop(); } catch(e){} bgOsc = null; }

  bgOsc = audioCtx.createOscillator();
  bgGain = audioCtx.createGain();

  bgOsc.type = 'triangle'; // Tr√≥jkƒÖtna fala jest dobra do technicznych dron√≥w
  
  // Domy≈õlnie (bezpiecznie - >3 p√≥l)
  bgOsc.frequency.value = 50; 
  bgGain.gain.value = 0.05;   

  bgOsc.connect(bgGain);
  bgGain.connect(audioCtx.destination);
  
  bgOsc.start();
}

function stopBackgroundDrone() {
  if (bgOsc) {
    const now = audioCtx.currentTime;
    bgGain.gain.exponentialRampToValueAtTime(0.001, now + 1);
    bgOsc.stop(now + 1);
    bgOsc = null;
  }
}

// --- KLUCZOWA ZMIANA: 5 POZIOM√ìW D≈πWIƒòKU ---
function updateDroneSound(distance) {
  if (!bgOsc || !audioCtx) return;

  const now = audioCtx.currentTime;
  let targetFreq, targetVol;

  if (distance === 0) {
    // Kolizja - d≈∫wiƒôk jest obs≈Çugiwany przez handleDeath, tu mo≈ºemy wyciszyƒá drona
    targetFreq = 50; targetVol = 0;
  } 
  else if (distance === 1) {
    // POZIOM 1 (Zagro≈ºenie bezpo≈õrednie) - Wysoki, g≈Ço≈õny
    targetFreq = 400; 
    targetVol = 0.35; 
  } 
  else if (distance === 2) {
    // POZIOM 2 (Blisko) - ≈öredni ton
    targetFreq = 200; 
    targetVol = 0.20;
  } 
  else if (distance === 3) {
    // POZIOM 3 (Nas≈Çuch) - Niski, ale podwy≈ºszony ton
    targetFreq = 100; 
    targetVol = 0.10;
  } 
  else {
    // POZIOM 3+ (Bezpiecznie) - G≈Çƒôboki bas
    targetFreq = 50; 
    targetVol = 0.05;
  }

  // P≈Çynne przej≈õcie (0.3s dla szybszej reakcji)
  bgOsc.frequency.linearRampToValueAtTime(targetFreq, now + 0.3);
  bgGain.gain.linearRampToValueAtTime(targetVol, now + 0.3);
}

// --- LOGIKA GRY ---

function showGame() {
  document.getElementById("game-area").style.display = "flex";
}
  
function startGame() {
  initAudioContext();
  startBackgroundDrone(); 

  const boardDiv = document.getElementById("board");
  const wormDiv  = document.getElementById("worm-map");

  board = [];
  gameOver = false;
  playerPos = {x:0, y:0};
  steps = 0;
  score = 0;
  
  document.getElementById("stats").innerText = "Kroki: 0 | Punktacja: 0";
  document.body.className = "";
  document.getElementById("helipadB").style.visibility = "hidden";

  boardDiv.innerHTML = "";
  wormDiv.innerHTML = "";
  boardDiv.style.gridTemplateColumns = `repeat(${size},50px)`;
  wormDiv.style.gridTemplateColumns  = `repeat(${size},20px)`;

  for (let y = 0; y < size; y++) {
    board[y] = [];
    for (let x = 0; x < size; x++) {
      board[y][x] = { worm:false, visited:false };

      const cell = document.createElement("div");
      cell.className = "cell";
      cell.dataset.x = x;
      cell.dataset.y = y;
      cell.onclick = () => moveTo(x,y);
      boardDiv.appendChild(cell);

      const wcell = document.createElement("div");
      wcell.className = "cell";
      wcell.dataset.x = x;
      wcell.dataset.y = y;
      wormDiv.appendChild(wcell);
    }
  }

  placeWorms();
  updateWormMap();
  drawBoard();
  
  // Sprawd≈∫ na starcie (powinno byƒá bezpiecznie)
  checkProximity(0,0);
}

function placeWorms() {
  let placed = 0;
  while (placed < wormsCount) {
    let x = Math.floor(Math.random() * size);
    let y = Math.floor(Math.random() * size);
    if ((x === 0 && y === 0) || (x === size-1 && y === size-1)) continue;
    if (!board[y][x].worm) {
      board[y][x].worm = true;
      placed++;
    }
  }
}

function moveWorms() {
  if (!document.getElementById("hardMode").checked) return;

  let newBoard = board.map(row => row.map(cell => ({...cell, worm:false})));

  for (let y = 0; y < size; y++) {
    for (let x = 0; x < size; x++) {
      if (board[y][x].worm) {
        const dirs = [[0,0],[0,-1],[0,1],[-1,0],[1,0]];
        const [dx,dy] = dirs[Math.floor(Math.random()*dirs.length)];
        let nx = x+dx, ny = y+dy;

        if (nx>=0 && nx<size && ny>=0 && ny<size &&
            !(nx===0 && ny===0) && !(nx===size-1 && ny===size-1)) {
          newBoard[ny][nx].worm = true;
        } else {
          newBoard[y][x].worm = true;
        }
      }
    }
  }
  for (let y = 0; y < size; y++) {
    for (let x = 0; x < size; x++) {
      board[y][x].worm = newBoard[y][x].worm;
    }
  }
  updateWormMap();
}

function updateWormMap() {
  const wormDiv = document.getElementById("worm-map");
  for (let y = 0; y < size; y++) {
    for (let x = 0; x < size; x++) {
      const cell = wormDiv.querySelector(`.cell[data-x='${x}'][data-y='${y}']`);
      if (x === playerPos.x && y === playerPos.y) {
          cell.textContent = "üë£";
      } else {
          cell.textContent = board[y][x].worm ? "ü™±" : "";
      }
    }
  }
}

function isAdjacent(x,y) {
  return Math.abs(playerPos.x-x)+Math.abs(playerPos.y-y)===1;
}

function moveTo(x,y) {
  if(gameOver || !isAdjacent(x,y)) return;
  initAudioContext();

  playerPos = {x,y};
  steps++;
  board[y][x].visited = true;

  score = Math.max(0, 100 - steps * 2);
  document.getElementById("stats").innerText = `Kroki: ${steps} | Punktacja: ${score}`;

  if (board[y][x].worm) {
    handleDeath();
    return;
  }

  moveWorms();

  if (board[playerPos.y][playerPos.x].worm) {
    handleDeath();
    return;
  }

  // Sprawd≈∫ blisko≈õƒá (5 poziom√≥w)
  checkProximity(x, y);

  if (x===size-1 && y===size-1) {
    alert(`Dotar≈Çe≈õ do celu! Punkty: ${score}`);
    document.getElementById("helipadB").style.visibility = "visible";
    stopBackgroundDrone();
    gameOver = true;
  }

  drawBoard();
  updateWormMap();
}

function handleDeath() {
  applyFeedback(0);
  revealWorms();
  updateWormMap();
  stopBackgroundDrone(); 
  playTone(100, "sawtooth", 0.5); 
  setTimeout(() => alert("Po≈ºar≈Ç Ciƒô Czerw Pustyni!"), 100);
  gameOver = true;
}

// === SONAR I EFEKTY T≈ÅA ===

function checkProximity(px, py) {
  let minDistance = 999;
  for(let y=0; y<size; y++) {
    for(let x=0; x<size; x++) {
      if(board[y][x].worm) {
        const dist = Math.abs(px - x) + Math.abs(py - y);
        if(dist < minDistance) minDistance = dist;
      }
    }
  }

  updateDroneSound(minDistance);
  applyFeedback(minDistance);
}

// --- KLUCZOWA ZMIANA: 5 POZIOM√ìW DRGA≈É ---
function applyFeedback(distance) {
  document.body.className = "";
  
  if (distance === 0) {
    // 0 p√≥l: Kolizja (Gwa≈Çtowne)
    document.body.classList.add("shake-dist-0");
  } else if (distance === 1) {
    // 1 pole: Zagro≈ºenie (Silne)
    document.body.classList.add("shake-dist-1");
  } else if (distance === 2) {
    // 2 pola: Blisko (≈örednie)
    document.body.classList.add("shake-dist-2");
  } else if (distance === 3) {
    // 3 pola: Nas≈Çuch (Mikro)
    document.body.classList.add("shake-dist-3");
  } 
  // 3+ p√≥l: Bezpiecznie (Brak drga≈Ñ)
}

function playTone(freq, type, vol) {
  if (!audioCtx) return;
  const osc = audioCtx.createOscillator();
  const gain = audioCtx.createGain();
  osc.type = type;
  osc.frequency.setValueAtTime(freq, audioCtx.currentTime);
  gain.gain.setValueAtTime(vol, audioCtx.currentTime);
  gain.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 0.5);
  osc.connect(gain);
  gain.connect(audioCtx.destination);
  osc.start();
  osc.stop(audioCtx.currentTime + 0.5);
}

function drawBoard() {
  for(let y=0;y<size;y++){
    for(let x=0;x<size;x++){
      const cell = document.querySelector(`.cell[data-x='${x}'][data-y='${y}']`);
      cell.className="cell";
      cell.textContent="";
      if(board[y][x].visited) cell.classList.add("visited");
      if(x===0 && y===0){ cell.classList.add("start"); cell.textContent="A"; }
      if(x===size-1 && y===size-1){ cell.classList.add("goal"); cell.textContent="B"; }
      if(x===playerPos.x && y===playerPos.y) cell.textContent="üë£";
    }
  }
}

function revealWorms() {
  for(let y=0;y<size;y++){
    for(let x=0;x<size;x++){
      if(board[y][x].worm){
        const cell = document.querySelector(`.cell[data-x='${x}'][data-y='${y}']`);
        cell.classList.add("worm");
        cell.textContent="ü™±";
      }
    }
  }
}

function playNarrator() {
  const audio = new Audio("Saper_Diuny.mp3");
  audio.play().catch(err => console.log("Nie uda≈Ço siƒô odtworzyƒá audio:", err));
}
</script>
</body>
</html>
